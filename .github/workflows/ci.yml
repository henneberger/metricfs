name: CI

on:
  push:
    branches:
      - main
  pull_request:

permissions:
  contents: read

jobs:
  test-and-build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Test
        run: go test ./...

      - name: Build (host)
        run: go build -o bin/metricfs ./cmd/metricfs

      - name: Cross-build smoke test
        run: |
          set -euo pipefail
          targets=(
            "linux amd64"
            "linux arm64"
            "darwin amd64"
            "darwin arm64"
            "windows amd64"
          )
          mkdir -p /tmp/metricfs-cross
          for t in "${targets[@]}"; do
            goos="${t%% *}"
            goarch="${t##* }"
            ext=""
            if [ "$goos" = "windows" ]; then
              ext=".exe"
            fi
            out="/tmp/metricfs-cross/metricfs_${goos}_${goarch}${ext}"
            GOOS="$goos" GOARCH="$goarch" CGO_ENABLED=0 go build -o "$out" ./cmd/metricfs
          done
